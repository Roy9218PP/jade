var _ = require('lodash');
var loaderUtils = require('loader-utils');
var template = require('../dist/template');
var runtimePath = require.resolve('art-template/loader/runtime');

module.exports = function(source) {
    this.cacheable && this.cacheable()

    var ANONYMOUS_RE = /^function\s+anonymous/

    template.onerror = function(e) {
        var message = 'Template Error\n\n';
        for (var name in e) {
            message += '<' + name + '>\n' + e[name] + '\n\n';
        }
        throw new SyntaxError(message)
    }

    try {
        var render = template.compile(source, {}).toString().replace(ANONYMOUS_RE, 'function');
        render = 'module.exports = require(JSON.stringify(' + runtimePath +'))(' + render + ');';

        this.callback(null, render)
    } catch (err) {
        this.callback(err)
    }
}